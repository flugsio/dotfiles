#!/bin/bash

# https://www.pivotaltracker.com/help/api/rest/v5#Endpoints

set -e

tmp=$(mktemp --suffix=.md)

if [ "$1" = "bug" ]; then
  # TODO: use another template
  cp ~/.config/bug_template $tmp
  story_type="bug"
  shift
elif [ "$1" = "errbit" ]; then
  cp ~/.config/errbit_template $tmp
  story_type="bug"
  shift
else
  cp ~/.config/story_template $tmp
  story_type="feature"
fi

vim $tmp

if [ "$1" = "soon" ]; then
  current_state="\"planned\""
  # unplanned label conveys it was injected into current sprint
  labels="\"unplanned\""
  owner_ids="[]"
  estimate="null"
elif [ "$1" = "now" ]; then
  current_state="\"planned\""
  # unplanned label conveys it was injected into current sprint
  labels="\"unplanned\""
  owner_ids="[1812784]"
  estimate="1"
else
  current_state="\"unscheduled\""
  labels=""
  owner_ids="[]"
  estimate="null"
fi

extra_label=$(echo -e "technical\nsecurity" | fzf --prompt "Extra label? (CTRL-C to cancel)" | echo "")

if [ -n "$extra_label" ]; then
  labels="$labels,\"${extra_label}\""
fi

name=$(head -n 1 $tmp | sed 's/"/\\"/g')
description=$(tail -n +2 $tmp | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

#-d "{\"name\":\"$name\",\"description\":\"$description\",\"labels\":[$labels]}" \
if [ -n "$name" ]; then
  curl -X POST -H "X-TrackerToken: $PT_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"name\":\"$name\",\"description\":\"$description\",\"story_type\":\"$story_type\",\"labels\":[$labels],\"current_state\":$current_state,\"owner_ids\":$owner_ids,\"estimate\":$estimate}" \
    "https://www.pivotaltracker.com/services/v5/projects/$PT_PROJECT_ID/stories" | jq .
else
  echo "Aborted due to missing story name"
  echo "Filename: $tmp"
fi
