#!/bin/sh
#set -e

# wip

function process
{
#  args="$@"
#  files=${args%%--*} # everything until --
#  opts=${args#*--}  # everything after --
#  echo files $files
#  echo opts $opts
  #opts="spec/controllers/i18n_controller_spec.rb --deprecation-out /dev/null --color -fp"

  #opts="-fd --order defined"
  files=$@

  declare -a results

  for file in $files; do
    command=`echo $file | sed -r "s/(\w+)\/?(.*)/cd \1 \&\& bundle exec rspec \2/"`
    #command=`echo $file | sed -r "s/(\w+)\/(.*)/cd \1 \&\& bundle exec rspec \2 spec\/promote\/promote\/copy_spec.rb/"`
    #command=`echo $file | sed -r "s/(\w+)\/(\w+)\/(.*)/bundle exec rake konacha:run SPEC=\3/"`
    if [ -n "$VAGMAC" ]; then
      command="ssh -ttF ~/.ssh/vagrant_config $VAGMAC \"bash -O huponexit -lc 'cd $VAGDIR; $command $opts'\""
    fi
    echo \($command $opts\)
    echo $command $opts | sh
    if [ $? -ne 0 ]; then
      results+=($file)
    fi
  done

  if [ ${#results[*]} -ne 0 ]; then
    echo Errors: ${results[*]}
  fi
}

if [ "$1" = "-" ]
then
  process "$(</dev/stdin)"
else
  process "$@"
fi
